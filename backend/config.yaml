# ========================================
# 配置说明：
# - 敏感信息（API密钥、密码）：从 .env 文件读取
# - 其他所有配置：从 config.yaml 读取
# ========================================

# K线配置
kline:
  interval: "15m"          # 支持：1m/3m/5m/15m/30m/1h/4h/1d
  history_size: 100        # 实时计算保留的K线数量
  warmup_size: 150         # 启动时预加载的历史K线数量

# 技术指标周期
indicators:
  atr_period: 14          # ATR周期
  stddev_period: 20       # 标准差周期
  volume_ma_period: 20    # 成交量移动平均周期
  bb_period: 20           # 布林带周期
  bb_std_multiplier: 2.0  # 布林带标准差倍数
  rsi_period: 14          # RSI周期
  ema_fast_period: 12     # EMA快线周期
  ema_slow_period: 26     # EMA慢线周期
  long_wick_ratio_threshold: 0.6  # 长影线比例阈值（占整根振幅）
  oi_ma_period: 20        # 持仓量移动平均周期
  oi_momentum_period: 10  # 持仓量动量周期
  oi_divergence_window: 5 # 持仓量背离分析窗口

# 异常检测配置（双门槛机制）
# 核心组A（波动性）：ATR, PRICE, VOLUME, BB_WIDTH - 至少2个触发
# 核心组B（突破/动量）：BB_BREAKOUT, OI_SURGE, OI_ZSCORE, MA_DEVIATION - 至少1个触发
# 默认阈值已内置于代码中，仅需覆盖时配置
detection:
  thresholds:
    # 核心组A阈值（可选覆盖，默认值见 detection/constants.py）
    # atr_zscore: 3.0
    # price_zscore: 3.0
    # volume_zscore: 3.5
    # bb_width_zscore: 3.0
    
    # 核心组B阈值
    # oi_zscore: 2.5
    # ma_deviation_zscore: 2.5
    
    # 门槛规则
    # min_group_a: 2
    # min_group_b: 1

# 告警配置
alert:
  cooldown_minutes: 0   # 同币种告警间隔（分钟）
  max_batch_size: 10     # 单次告警最多包含的币种数
  send_email: false      # 是否发送告警邮件（false=禁用告警邮件，仅写入JSONL）
  debounce_seconds: 10   # 防抖延迟（秒），收集同一周期内的告警后批量发送
  
# WebSocket配置
websocket:
  base_url: "wss://fstream.binance.com"
  max_streams_per_connection: 1024
  reconnect_delay: 5      # 重连延迟（秒）
  max_reconnect_attempts: 10
  ping_interval: 180      # 心跳间隔（秒）

# REST API配置
api:
  base_url: "https://fapi.binance.com"
  timeout: 10             # 请求超时（秒）
  retry_times: 3          # 重试次数

# 持仓量监控配置（与K线告警同步）
open_interest:
  enabled: true           # 是否启用持仓量监控
  history_size: 30        # 保留的历史数据数量
  min_oi_change: 3.0      # 最小持仓量变化率（百分比），低于此值不告警

# 交易模式配置
trading:
  mode: "simulator"            # 交易模式：simulator（模拟）/ live（实盘）
  max_leverage: 10        # 最大杠杆倍数
  history_sync_days: 0    # 启动时同步历史持仓天数（0=禁用，最大7天）

# 交易对过滤
symbols:
  quote_asset: "USDT"     # 报价资产
  contract_type: "PERPETUAL"  # 合约类型
  min_volume_24h: 50000000     # 最小24h成交量（USDT）
  exclude: []             # 排除列表（如：["BTCDOMUSDT"]）
  update_interval_minutes: 60  # 交易对列表更新间隔（分钟）

# Agent 配置
agent:
  # 模型配置（敏感信息，从 .env 读取）
  # AGENT_MODEL, AGENT_BASE_URL, AGENT_API_KEY 必须在 .env 中设置
  
  # Agent 运行配置（从 config.yaml 读取）
  default_interval_min: 30  # 默认唤醒间隔（分钟）
  
  # 文件路径配置（统一存放在 modules/data 目录下，相对于 backend 目录）
  alerts_jsonl_path: "modules/data/alerts.jsonl"
  reports_json_path: "modules/data/agent_reports.json"
  position_history_path: "modules/data/position_history.json"
  state_path: "modules/data/state.json"
  trade_state_path: "modules/data/trade_state.json"
  workflow_trace_path: "modules/data/workflow_trace.jsonl"  # 保留用于兼容
  workflow_index_path: "modules/data/workflow_index.jsonl"  # 新增：索引文件
  workflow_traces_dir: "modules/data/workflow_traces"       # 新增：分文件存储目录
  workflow_artifacts_dir: "modules/data/artifacts"
  
  # 回测配置
  backtest:
    kline_cache_dir: "modules/data/kline_cache"  # K线本地缓存目录
  
  # 模拟交易引擎配置
  simulator:
    initial_balance: 1000.0    # 初始余额（USDT）
    taker_fee_rate: 0.0005      # Taker手续费率（0.05%）
    max_leverage: 10            # 最大杠杆倍数
    ws_interval: "1m"           # WebSocket K线订阅间隔
  
  # 反向交易引擎文件路径配置（数值配置通过前端动态管理）
  reverse:
    config_path: "modules/data/reverse_config.json"           # 动态配置文件
    algo_orders_path: "modules/data/reverse_algo_orders.json" # 条件单状态
    trade_records_path: "modules/data/reverse_trade_records.json" # 开仓记录
    history_path: "modules/data/reverse_history.json"         # 历史记录
  
  # 决策验证配置（基于 logprobs 的置信度检查）
  decision_verification:
    enabled: true               # 是否启用决策验证
    threshold: 0.70             # 加权平均置信度阈值（0-1）
    
    # 各工具的检查点权重配置（每个工具的权重总和应为1.0）
    weights:
      # open_position 检查点权重
      open_position:
        multi_timeframe_aligned: 0.27      # 多周期共振
        tp_sl_ratio_valid: 0.33            # 止盈止损比例（最重要）
        volume_confirmed: 0.17             # 成交量确认
        trend_strength_sufficient: 0.23    # 趋势强度
      
      # close_position 检查点权重
      close_position:
        trend_reversed: 0.30               # 趋势反转确认（最重要）
        structure_broken: 0.25             # 关键结构破坏
        volume_confirmed: 0.25             # 反向成交量确认
        timing_reasonable: 0.20            # 平仓时机合理
    
    target_tools:               # 需要验证的工具列表
      - open_position           # 开仓工具
      - close_position          # 平仓工具（防止恐慌性止损）
      # - update_tp_sl          # 可选：也验证止盈止损调整
