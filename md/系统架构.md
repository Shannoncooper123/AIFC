# åŠ å¯†è´§å¸äº¤æ˜“ç›‘æ§ä¸è‡ªåŠ¨åŒ–äº¤æ˜“ç³»ç»Ÿæ¶æ„

## ç³»ç»Ÿæ¦‚è§ˆ

æœ¬ç³»ç»Ÿç”±ä¸¤ä¸ª**ç‹¬ç«‹è¿è¡Œ**çš„æ¨¡å—ç»„æˆï¼š
1. **å‘Šè­¦ç›‘æ§æ¨¡å—**ï¼šå®æ—¶ç›‘æ§å¸‚åœºå¼‚å¸¸æ³¢åŠ¨
2. **AI äº¤æ˜“ Agent**ï¼šå®šæ—¶åˆ†æå¹¶æ‰§è¡Œæ¨¡æ‹Ÿäº¤æ˜“

ä¸¤ä¸ªæ¨¡å—é€šè¿‡**æ–‡ä»¶ç³»ç»Ÿ**è§£è€¦é€šä¿¡ï¼Œäº’ä¸ä¾èµ–ã€‚

### æ ¸å¿ƒç»„æˆ

```mermaid
graph TB
    subgraph "æ•°æ®æº"
        BinanceWS["Binance WebSocket<br/>å®æ—¶Kçº¿æµ"]
        BinanceREST["Binance REST API<br/>å†å²æ•°æ®/äº¤æ˜“"]
    end

    subgraph "å‘Šè­¦ç›‘æ§æ¨¡å— - æŒç»­è¿è¡Œ"
        Core["æ ¸å¿ƒç®¡ç†å±‚"]
        Data["æ•°æ®ç®¡ç†å±‚"]
        Detection["å¼‚å¸¸æ£€æµ‹å±‚"]
        Indicators["æŠ€æœ¯æŒ‡æ ‡å±‚"]
        Alerts["å‘Šè­¦é€šçŸ¥å±‚"]
    end

    subgraph "æ–‡ä»¶ç³»ç»Ÿè§£è€¦å±‚"
        AlertsFile["alerts.jsonl<br/>å‘Šè­¦è®°å½•æµæ°´"]
        ReportsFile["agent_reports.json<br/>åˆ†ææŠ¥å‘Š"]
        HistoryFile["position_history.json<br/>äº¤æ˜“å†å²"]
    end

    subgraph "AI äº¤æ˜“ Agent - å®šæ—¶æ‰§è¡Œ"
        AgentMain["agent_main.py<br/>è¿›ç¨‹å…¥å£"]
        
        subgraph "LangChain Agent"
            Middleware["ContextInjection<br/>Middleware"]
            Tools["9ä¸ªå·¥å…·<br/>@tool"]
        end
        
        Simulator["TradeSimulatorEngine<br/>å•ä¾‹æœåŠ¡"]
    end

    subgraph "çŠ¶æ€æŒä¹…åŒ–"
        StateFiles["state.json<br/>trade_state.json"]
    end

    BinanceWS --> Core
    BinanceREST --> Core
    Core --> Data
    Data --> Indicators
    Indicators --> Detection
    Detection --> Alerts
    Alerts --> AlertsFile
    
    AgentMain -.å®šæ—¶è¯»å–.-> AlertsFile
    AgentMain --> |åˆ›å»ºAgent| Middleware
    AgentMain --> |åˆ›å»ºAgent| Tools
    AgentMain --> |set_engine| Simulator
    
    Middleware -.get_engine.-> Simulator
    Tools -.get_engine.-> Simulator
    
    Simulator --> BinanceREST
    Tools --> ReportsFile
    Simulator --> HistoryFile
    Simulator --> StateFiles
    
    style Core fill:#e1f5ff
    style AgentMain fill:#fff4e1
    style Simulator fill:#ffe1e1
    style AlertsFile fill:#f0f0f0,stroke:#333,stroke-width:3px
```

**æ¶æ„ç‰¹ç‚¹ï¼š**

**æ¨¡å—é—´é€šä¿¡ï¼š**
- ğŸ”„ **å‘Šè­¦æ¨¡å—**ï¼šæŒç»­è¿è¡Œï¼Œå®æ—¶ç›‘æ§ï¼Œå†™å…¥ `alerts.jsonl`
- â° **Agent æ¨¡å—**ï¼šå®šæ—¶æ‰§è¡Œï¼Œè¯»å– `alerts.jsonl`ï¼Œç‹¬ç«‹å†³ç­–
- ğŸ“ **æ–‡ä»¶è§£è€¦**ï¼šä¸¤ä¸ªæ¨¡å—é€šè¿‡æ–‡ä»¶ç³»ç»Ÿé€šä¿¡ï¼Œäº’ä¸é˜»å¡

**Agent å†…éƒ¨æ¶æ„ï¼š**
- ğŸ¯ **LangChain Agent**ï¼šåŒ…å« Middleware å’Œ Tools
- ğŸ”— **å•ä¾‹æœåŠ¡**ï¼šTradeSimulatorEngine é€šè¿‡ `get_engine()` è¢«è®¿é—®
- ğŸ› ï¸ **è§£è€¦è®¾è®¡**ï¼šTools å’Œ Middleware é€šè¿‡å•ä¾‹æ¨¡å¼è®¿é—®å¼•æ“ï¼Œæ— ç›´æ¥ä¾èµ–

---

## 1. å‘Šè­¦ç›‘æ§æ¨¡å— (src/)

### 1.1 æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "Core æ ¸å¿ƒç®¡ç†å±‚"
        EM["ExchangeManager<br/>äº¤æ˜“å¯¹ç®¡ç†"]
        Init["Initializer<br/>ç³»ç»Ÿåˆå§‹åŒ–"]
        SU["SymbolUpdater<br/>äº¤æ˜“å¯¹æ›´æ–°"]
    end

    subgraph "Data æ•°æ®ç®¡ç†å±‚"
        KM["KlineManager<br/>Kçº¿æ•°æ®ç®¡ç†"]
        Models["æ•°æ®æ¨¡å‹<br/>Kline/Symbol"]
    end

    subgraph "Clients å®¢æˆ·ç«¯å±‚"
        WSClient["BinanceWSClient<br/>WebSocketè¿æ¥"]
        RESTClient["BinanceRESTClient<br/>REST API"]
    end

    subgraph "Indicators æŠ€æœ¯æŒ‡æ ‡å±‚"
        Calc["Calculator<br/>æŒ‡æ ‡åè°ƒå™¨"]
        ATR["ATRæŒ‡æ ‡"]
        Vol["VolatilityæŒ‡æ ‡<br/>BB/MA/RSI"]
        Volume["æˆäº¤é‡æŒ‡æ ‡"]
        Pattern["Kçº¿å½¢æ€è¯†åˆ«"]
    end

    subgraph "Detection å¼‚å¸¸æ£€æµ‹å±‚"
        Detector["Detector<br/>å¼‚å¸¸æ£€æµ‹å™¨"]
        Strategies["æ£€æµ‹ç­–ç•¥<br/>15ç§ä»¥ä¸ŠæŒ‡æ ‡ç­–ç•¥"]
        ZScore["Z-Scoreè®¡ç®—"]
    end

    subgraph "Alerts å‘Šè­¦é€šçŸ¥å±‚"
        AM["AlertManager<br/>å‘Šè­¦ç®¡ç†"]
        Notifier["Notifier<br/>é‚®ä»¶é€šçŸ¥"]
        CB["Callbacks<br/>å‘Šè­¦å›è°ƒ"]
    end

    WSClient --> KM
    RESTClient --> KM
    EM --> WSClient
    EM --> KM
    
    KM --> Calc
    Calc --> ATR
    Calc --> Vol
    Calc --> Volume
    Calc --> Pattern
    
    ATR --> Detector
    Vol --> Detector
    Volume --> Detector
    Pattern --> Detector
    
    Detector --> Strategies
    Strategies --> ZScore
    Strategies --> AM
    
    AM --> CB
    AM --> Notifier
    
    style EM fill:#e3f2fd
    style KM fill:#f3e5f5
    style Detector fill:#fff3e0
    style AM fill:#e8f5e9
```

### 1.2 æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### Core æ ¸å¿ƒç®¡ç†å±‚

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **ExchangeManager** | `exchange_manager.py` | â€¢ ç®¡ç†æ´»è·ƒäº¤æ˜“å¯¹åˆ—è¡¨<br/>â€¢ åè°ƒ WebSocket è¿æ¥<br/>â€¢ å¯åŠ¨/åœæ­¢ç›‘æ§æµç¨‹ |
| **Initializer** | `initializer.py` | â€¢ ç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–<br/>â€¢ é¢„çƒ­å†å²æ•°æ®<br/>â€¢ é…ç½®åŠ è½½éªŒè¯ |
| **SymbolUpdater** | `symbol_updater.py` | â€¢ å®šæ—¶æ›´æ–°äº¤æ˜“å¯¹åˆ—è¡¨<br/>â€¢ è¿‡æ»¤ä½æˆäº¤é‡å¸ç§<br/>â€¢ å¤„ç†äº¤æ˜“å¯¹å˜æ›´ |

#### Data æ•°æ®ç®¡ç†å±‚

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **KlineManager** | `kline_manager.py` | â€¢ ç»´æŠ¤ K çº¿æ•°æ®ç¼“å­˜<br/>â€¢ å¤„ç†å®æ—¶ K çº¿æ›´æ–°<br/>â€¢ æä¾›å†å²æ•°æ®æŸ¥è¯¢æ¥å£ |
| **Models** | `models.py` | â€¢ å®šä¹‰ Kline æ•°æ®æ¨¡å‹<br/>â€¢ å®šä¹‰ Symbol æ•°æ®æ¨¡å‹<br/>â€¢ æä¾›æ•°æ®åºåˆ—åŒ–æ–¹æ³• |

#### Indicators æŠ€æœ¯æŒ‡æ ‡å±‚

```mermaid
graph LR
    Input["Kçº¿æ•°æ®"] --> Calculator
    
    subgraph Calculator
        ATR["ATRæ³¢åŠ¨ç‡"]
        BB["å¸ƒæ—å¸¦"]
        MA["ç§»åŠ¨å¹³å‡çº¿"]
        RSI["RSIæŒ‡æ ‡"]
        VOL["æˆäº¤é‡MA"]
        Pattern["Kçº¿å½¢æ€"]
    end
    
    Calculator --> Output["æŠ€æœ¯æŒ‡æ ‡ç»“æœ"]
    
    style Calculator fill:#f0f0f0
```

| æ¨¡å— | æ–‡ä»¶ | æ”¯æŒçš„æŒ‡æ ‡ |
|------|------|-----------|
| **ATR** | `atr.py` | â€¢ ATRï¼ˆå¹³å‡çœŸå®æ³¢å¹…ï¼‰<br/>â€¢ ATR Z-Score |
| **Volatility** | `volatility.py` | â€¢ å¸ƒæ—å¸¦ï¼ˆBBï¼‰<br/>â€¢ å¸ƒæ—å¸¦å®½åº¦<br/>â€¢ EMA å¿«çº¿/æ…¢çº¿<br/>â€¢ MA ä¹–ç¦»åº¦<br/>â€¢ RSI åŠå…¶ Z-Score |
| **Volume** | `volume.py` | â€¢ æˆäº¤é‡ç§»åŠ¨å¹³å‡<br/>â€¢ æˆäº¤é‡ Z-Score |
| **Pattern** | `pattern.py` | â€¢ å¤–åŒ…çº¿è¯†åˆ«ï¼ˆçœ‹æ¶¨/çœ‹è·Œï¼‰<br/>â€¢ é•¿ä¸Šå½±çº¿/é•¿ä¸‹å½±çº¿ |
| **Calculator** | `calculator.py` | â€¢ æŒ‡æ ‡è®¡ç®—åè°ƒå™¨<br/>â€¢ æ‰¹é‡è®¡ç®—æ¥å£ |

#### Detection å¼‚å¸¸æ£€æµ‹å±‚

**æ”¯æŒçš„ 15+ ç§æ£€æµ‹ç­–ç•¥ï¼š**

```mermaid
mindmap
  root((å¼‚å¸¸æ£€æµ‹ç­–ç•¥))
    æ³¢åŠ¨ç‡ç±»
      ATRå¼‚å¸¸
      å¸ƒæ—å¸¦çªç ´ä¸Šè½¨
      å¸ƒæ—å¸¦çªç ´ä¸‹è½¨
      å¸ƒæ—å¸¦æŒ¤å‹åæ‰©å¼ 
      å¸ƒæ—å¸¦å®½åº¦å¼‚å¸¸
    ä»·æ ¼ç±»
      ä»·æ ¼å˜åŒ–å¼‚å¸¸
      å‡çº¿é‡‘å‰
      å‡çº¿æ­»å‰
      å‡çº¿ä¹–ç¦»å¼‚å¸¸
    æˆäº¤é‡ç±»
      æˆäº¤é‡å¼‚å¸¸
    å½¢æ€ç±»
      çœ‹æ¶¨å¤–åŒ…çº¿
      çœ‹è·Œå¤–åŒ…çº¿
      é•¿ä¸Šå½±çº¿
      é•¿ä¸‹å½±çº¿
    åŠ¨é‡ç±»
      RSIè¶…ä¹°
      RSIè¶…å–
      RSIå¼‚å¸¸
```

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **Detector** | `detector.py` | â€¢ åè°ƒæ‰€æœ‰æ£€æµ‹ç­–ç•¥<br/>â€¢ è®¡ç®—å¼‚å¸¸ç­‰çº§ï¼ˆ1-5ï¼‰<br/>â€¢ ç”Ÿæˆå‘Šè­¦æ¡ç›® |
| **Strategies** | `strategies.py` | â€¢ å®ç°å…·ä½“æ£€æµ‹é€»è¾‘<br/>â€¢ é˜ˆå€¼åˆ¤æ–­<br/>â€¢ æŒ‡æ ‡ç»„åˆåˆ†æ |
| **ZScore** | `zscore.py` | â€¢ Z-Score æ ‡å‡†åŒ–è®¡ç®—<br/>â€¢ æ»šåŠ¨çª—å£ç»Ÿè®¡<br/>â€¢ å¼‚å¸¸å€¼è¯†åˆ« |

#### Alerts å‘Šè­¦é€šçŸ¥å±‚

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **AlertManager** | `manager.py` | â€¢ èšåˆå¤šå¸ç§å‘Šè­¦<br/>â€¢ æŒ‰æ—¶é—´çª—å£æ‰¹é‡å¤„ç†<br/>â€¢ å†™å…¥ alerts.jsonl |
| **Notifier** | `notifier.py` | â€¢ SMTP é‚®ä»¶å‘é€<br/>â€¢ å‘Šè­¦å†…å®¹æ ¼å¼åŒ–<br/>â€¢ å¤±è´¥é‡è¯•æœºåˆ¶ |
| **Callbacks** | `callbacks.py` | â€¢ K çº¿å›è°ƒå¤„ç†<br/>â€¢ è§¦å‘å¼‚å¸¸æ£€æµ‹æµç¨‹ |

---

## 2. AI äº¤æ˜“ Agent (agent/)

### 2.1 æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "Agent å¯åŠ¨å±‚"
        Main["agent_main.py<br/>è¿›ç¨‹å…¥å£"]
        LogReader["log_reader.py<br/>è¯»å– alerts.jsonl"]
        State["state.py<br/>çŠ¶æ€ç®¡ç†"]
    end

    subgraph "LangChain Agent"
        LLM["ChatOpenAI<br/>å¤§è¯­è¨€æ¨¡å‹"]
        
        subgraph "Middleware Hook"
            Context["ContextInjectionMiddleware<br/>before_agent hook"]
        end
        
        subgraph "Tools å·¥å…·é›†"
            MarketTools["å¸‚åœºæ•°æ®å·¥å…·<br/>get_kline/get_indicators"]
            TradingTools["äº¤æ˜“æ“ä½œå·¥å…·<br/>open/close/update_tp_sl"]
            ReportTools["æŠ¥å‘Šå·¥å…·<br/>write_report"]
        end
        
        Core["Agent æ ¸å¿ƒ<br/>å†³ç­–å¾ªç¯"]
    end

    subgraph "Trade Simulator å•ä¾‹æœåŠ¡"
        Engine["TradeSimulatorEngine<br/>å…¨å±€å•ä¾‹<br/>é€šè¿‡ get_engine è®¿é—®"]
        
        subgraph "æ ¸å¿ƒæœåŠ¡"
            PM["PositionManager"]
            TPSL["TPSLManager"]
            Risk["RiskService"]
            StateMgr["StateManager"]
        end
        
        MarketSub["MarketSubscription<br/>WebSocket"]
    end

    Main --> LogReader
    Main --> |åˆå§‹åŒ–å¼•æ“<br/>set_engine| Engine
    Main --> |åˆ›å»ºAgent| LLM
    
    LLM --> Core
    Core --> Context
    Core --> MarketTools
    Core --> TradingTools
    Core --> ReportTools
    
    Context -.get_engine<br/>è·å–è´¦æˆ·/æŒä»“.-> Engine
    MarketTools -.get_engine<br/>è·å–æ•°æ®.-> Engine
    TradingTools -.get_engine<br/>æ‰§è¡Œäº¤æ˜“.-> Engine
    ReportTools -.å†™å…¥æ–‡ä»¶.-> State
    
    Engine --> PM
    Engine --> TPSL
    Engine --> Risk
    Engine --> StateMgr
    Engine --> MarketSub
    
    MarketSub -.å®æ—¶Kçº¿.-> TPSL
    
    style Main fill:#fff9c4
    style LLM fill:#c8e6c9
    style Engine fill:#ffccbc,stroke:#e64a19,stroke-width:3px
    style Core fill:#e1f5fe
```

**æ¶æ„è¯´æ˜ï¼š**

1. **Agent å¯åŠ¨å±‚**ï¼š
   - `agent_main.py`ï¼šè¿›ç¨‹å…¥å£ï¼Œåˆå§‹åŒ–å¼•æ“å’Œ Agent
   - è¯»å– `alerts.jsonl` è·å–å¸‚åœºä¿¡æ¯
   - åˆ›å»º TradeSimulatorEngine å¹¶è®¾ä¸ºå…¨å±€å•ä¾‹

2. **LangChain Agent**ï¼š
   - é€šè¿‡ `create_agent()` åˆ›å»º
   - åŒ…å« Middlewareï¼ˆbefore_agent hookï¼‰
   - åŒ…å« 9 ä¸ªå·¥å…·ï¼ˆToolsï¼‰
   - Agent æ ¸å¿ƒè´Ÿè´£å†³ç­–å¾ªç¯

3. **Trade Simulator å•ä¾‹**ï¼š
   - ç‹¬ç«‹çš„æœåŠ¡å±‚
   - é€šè¿‡ `get_engine()` è¢«è®¿é—®
   - ç®¡ç†æ‰€æœ‰äº¤æ˜“ç›¸å…³é€»è¾‘

### 2.2 æ ¸å¿ƒæµç¨‹

#### Agent æ‰§è¡Œæµç¨‹

```mermaid
sequenceDiagram
    participant Scheduler as å¤–éƒ¨è°ƒåº¦å™¨
    participant Main as agent_main.py
    participant AlertsFile as alerts.jsonl
    participant Engine as TradeSimulator<br/>Engine (å•ä¾‹)
    
    box LangChain Agent
        participant Middleware as ContextInjection<br/>Middleware
        participant AgentCore as Agent æ ¸å¿ƒ
        participant Tools as Tools (9ä¸ª)
    end
    
    participant Files as æ–‡ä»¶ç³»ç»Ÿ

    Note over Scheduler,Main: 1. Agent å¯åŠ¨ï¼ˆå®šæ—¶è§¦å‘ï¼‰
    Scheduler->>Scheduler: æ£€æŸ¥ state.json<br/>next_wakeup_ts
    Scheduler->>Main: åˆ°æ—¶é—´ â†’ å¯åŠ¨
    Main->>AlertsFile: è¯»å–æœ€æ–°å‘Šè­¦
    Main->>Engine: set_engine(eng)<br/>åˆå§‹åŒ–å•ä¾‹
    Main->>AgentCore: create_agent()<br/>æ³¨å†Œä¸­é—´ä»¶å’Œå·¥å…·
    
    Note over Middleware,Tools: 2. before_agent Hookï¼ˆè¿è¡Œä¸€æ¬¡ï¼‰
    AgentCore->>Middleware: before_agent(state, runtime)
    Middleware->>Engine: get_engine().get_account_summary()
    Engine-->>Middleware: è´¦æˆ·ä¿¡æ¯
    Middleware->>Engine: get_engine().get_positions_summary()
    Engine-->>Middleware: æŒä»“ä¿¡æ¯
    Middleware->>Middleware: è·å–å‰5å¸ç§15m Kçº¿
    Middleware-->>AgentCore: è¿”å› [ä¸Šä¸‹æ–‡æ¶ˆæ¯, è§¦å‘æ¶ˆæ¯]
    
    Note over AgentCore,Tools: 3. Agent å†³ç­–å¾ªç¯
    loop LLM å†³ç­–å¾ªç¯
        AgentCore->>AgentCore: LLM åˆ†æå¹¶å†³å®šè°ƒç”¨å·¥å…·
        
        alt è°ƒç”¨å¸‚åœºæ•°æ®å·¥å…·
            AgentCore->>Tools: get_kline("BTCUSDT", "3m")
            Tools->>Engine: get_engine() è®¿é—®
            Engine-->>Tools: Kçº¿æ•°æ®
            Tools-->>AgentCore: è¿”å›ç»“æœ
        end
        
        alt è°ƒç”¨äº¤æ˜“å·¥å…·
            AgentCore->>Tools: open_position(...)
            Tools->>Engine: get_engine().open_position()
            Engine->>Engine: æ›´æ–°æŒä»“å’Œè´¦æˆ·
            Engine-->>Tools: æ‰§è¡Œç»“æœ
            Tools-->>AgentCore: è¿”å›ç»“æœ
        end
        
        AgentCore->>AgentCore: LLM ç»§ç»­åˆ†æ...
    end
    
    Note over AgentCore,Files: 4. ç”ŸæˆæŠ¥å‘Šå¹¶é€€å‡º
    AgentCore->>Tools: write_report(summary, ...)
    Tools->>Files: å†™å…¥ agent_reports.json
    Tools->>Files: å†™å…¥ state.json<br/>(next_wakeup_ts)
    Tools-->>AgentCore: å®Œæˆ
    
    AgentCore-->>Main: æ‰§è¡Œå®Œæˆ
    Main->>Main: è¿›ç¨‹é€€å‡º
    
    Note over Scheduler,Files: ç­‰å¾…ä¸‹æ¬¡å”¤é†’...
```

**æµç¨‹å…³é”®ç‚¹ï¼š**

| é˜¶æ®µ | è¯´æ˜ |
|------|------|
| **å¯åŠ¨** | `agent_main.py` åˆå§‹åŒ–å¼•æ“å¹¶åˆ›å»º LangChain Agent |
| **before_agent** | Middleware é€šè¿‡ `get_engine()` æ„é€ åˆå§‹ä¸Šä¸‹æ–‡ |
| **å†³ç­–å¾ªç¯** | Agent æ ¸å¿ƒåå¤è°ƒç”¨ Toolsï¼ŒTools é€šè¿‡ `get_engine()` è®¿é—®å¼•æ“ |
| **æŠ¥å‘Šç”Ÿæˆ** | `write_report` å·¥å…·å†™å…¥æ–‡ä»¶å¹¶è®¾ç½®ä¸‹æ¬¡å”¤é†’æ—¶é—´ |
| **é€€å‡º** | è¿›ç¨‹ç»“æŸï¼Œç­‰å¾…è°ƒåº¦å™¨ä¸‹æ¬¡å¯åŠ¨ |

### 2.3 æ¨¡å—è¯¦è§£

#### Agent ä¸»æ§å±‚

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **agent_main** | `agent_main.py` | â€¢ ç³»ç»Ÿå…¥å£ç‚¹ï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰<br/>â€¢ é€šè¿‡ `log_reader` è¯»å– `/data/alerts.jsonl`<br/>â€¢ åˆ›å»º LangChain Agent<br/>â€¢ åˆå§‹åŒ–å·¥å…·å’Œä¸­é—´ä»¶<br/>â€¢ æ‰§è¡Œå®Œæˆåè®¾ç½®ä¸‹æ¬¡å”¤é†’æ—¶é—´å¹¶é€€å‡º |
| **state** | `state.py` | â€¢ ç®¡ç† Agent çŠ¶æ€ï¼ˆ`state.json`ï¼‰<br/>â€¢ å­˜å‚¨ä¸‹æ¬¡å”¤é†’æ—¶é—´æˆ³<br/>â€¢ è¿è¡Œå†å²è®°å½• |
| **log_reader** | `log_reader.py` | â€¢ è¯»å– `data/alerts.jsonl` æ–‡ä»¶<br/>â€¢ è§£ææœ€æ–°çš„èšåˆå‘Šè­¦è®°å½•<br/>â€¢ ä¸º Agent æä¾›å¸‚åœºå¼‚å¸¸ä¿¡æ¯ |

#### Middleware ä¸­é—´ä»¶å±‚

**ContextInjectionMiddleware** (`middleware/context_injection_middleware.py`)

> LangChain AgentMiddleware çš„å®ç°ï¼Œåœ¨ `create_agent()` æ—¶æ³¨å†Œ

**å·¥ä½œæœºåˆ¶ï¼š**

```python
class ContextInjectionMiddleware(AgentMiddleware):
    def before_agent(self, state, runtime):
        # 1. é€šè¿‡ get_engine() è·å–è´¦æˆ·å’ŒæŒä»“æ‘˜è¦
        account_summary = get_engine().get_account_summary()
        positions_summary = get_engine().get_positions_summary()
        
        # 2. è¯»å–å‘Šè­¦æ•°æ®å¹¶æ’åº
        # 3. ä¸ºå‰5ä¸ªå¸ç§è°ƒç”¨ BinanceRestClient è·å–15åˆ†é’ŸKçº¿
        # 4. æ„é€ ç»“æ„åŒ–ä¸Šä¸‹æ–‡æ¶ˆæ¯
        # 5. æ³¨å…¥ HumanMessage åˆ° Agent å¯¹è¯å¼€å§‹
        
        return {"messages": [context_msg, trigger_msg]}
```

**åŠŸèƒ½ç‰¹ç‚¹ï¼š**
- ğŸ¯ **before_agent hook**ï¼šåœ¨ Agent æ‰§è¡Œå‰è¿è¡Œä¸€æ¬¡
- ğŸ“Š **é¢„åŠ è½½æ•°æ®**ï¼šå‰5ä¸ªä¼˜å…ˆçº§å¸ç§çš„15æ ¹Kçº¿
- ğŸ”— **å•ä¾‹è®¿é—®**ï¼šé€šè¿‡ `get_engine()` è·å–è´¦æˆ·/æŒä»“ä¿¡æ¯
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ Agent åˆå§‹å·¥å…·è°ƒç”¨ï¼ŒåŠ å¿«é¦–æ¬¡å†³ç­–

**ä¼˜åŠ¿ï¼š**
| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| å‡å°‘å·¥å…·è°ƒç”¨ | Agent å¯åŠ¨æ—¶å·²æœ‰å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œæ— éœ€å¤šæ¬¡è°ƒç”¨ get_kline |
| å®Œæ•´åˆå§‹ä¿¡æ¯ | è´¦æˆ·çŠ¶æ€ + æŒä»“è¯¦æƒ… + å‰5å¸ç§Kçº¿ä¸€æ¬¡æ€§æ³¨å…¥ |
| åŠ å¿«å†³ç­–é€Ÿåº¦ | è·³è¿‡æ•°æ®æ”¶é›†é˜¶æ®µï¼Œç›´æ¥è¿›å…¥åˆ†æå†³ç­– |

#### Tools å·¥å…·é›†

> æ‰€æœ‰å·¥å…·éƒ½æ˜¯é€šè¿‡ `@tool` è£…é¥°å™¨å®šä¹‰ï¼Œåœ¨ `create_agent()` æ—¶æ³¨å†Œåˆ° Agent

**å·¥å…·è®¿é—®æ¨¡å¼ï¼š**

```python
# å·¥å…·å†…éƒ¨é€šè¿‡å•ä¾‹è®¿é—® TradeSimulatorEngine
from agent.trade_simulator import get_engine

@tool("open_position")
def open_position_tool(symbol: str, side: str, notional_usdt: float, ...):
    eng = get_engine()  # è·å–å…¨å±€å•ä¾‹
    result = eng.open_position(...)  # è°ƒç”¨å¼•æ“æ–¹æ³•
    return result
```

**9 ä¸ªå·¥å…·åˆ†ç±»ï¼š**

**1. å¸‚åœºæ•°æ®å·¥å…·** (`tools/`)

| å·¥å…· | æ–‡ä»¶ | åŠŸèƒ½ | æ•°æ®æ¥æº |
|------|------|------|---------|
| **get_kline** | `get_kline_tool.py` | è·å–Kçº¿æ•°æ®ï¼ˆ3m/15m/1h/4hï¼‰ | BinanceRestClient |
| **get_indicators** | `get_indicators_tool.py` | è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆATR/RSI/EMA/BBç­‰ï¼‰ | BinanceRestClient + æœ¬åœ°è®¡ç®— |
| **get_account** | `get_account_tool.py` | è·å–è´¦æˆ·æ‘˜è¦ï¼ˆä½™é¢/æƒç›Š/ä¿è¯é‡‘åˆ©ç”¨ç‡ï¼‰ | `eng.get_account_summary()` |
| **get_positions** | `get_positions_tool.py` | è·å–å½“å‰æŒä»“åˆ—è¡¨ | `eng.get_positions_summary()` |

**2. äº¤æ˜“æ“ä½œå·¥å…·** (`tools/`)

| å·¥å…· | æ–‡ä»¶ | åŠŸèƒ½ | å¼•æ“æ–¹æ³• |
|------|------|------|---------|
| **open_position** | `open_position_tool.py` | å¼€ä»“/åŠ ä»“ï¼Œæ”¯æŒç™¾åˆ†æ¯”TP/SL | `eng.open_position()` |
| **close_position** | `close_position_tool.py` | å…¨å¹³ä»“ | `eng.close_position()` |
| **update_tp_sl** | `update_tp_sl_tool.py` | æ›´æ–°æŒä»“çš„æ­¢ç›ˆæ­¢æŸä»·æ ¼ | `eng.update_tp_sl()` |

**3. æŠ¥å‘Šå·¥å…·** (`tools/`)

| å·¥å…· | æ–‡ä»¶ | åŠŸèƒ½ | è¾“å‡º |
|------|------|------|------|
| **write_report** | `write_report_tool.py` | ç”Ÿæˆåˆ†ææŠ¥å‘Šå¹¶è®¾ç½®ä¸‹æ¬¡å”¤é†’æ—¶é—´ | `agent_reports.json` + `state.json` |
| **send_email** | `send_email_tool.py` | å‘é€é‚®ä»¶é€šçŸ¥ | SMTP |

#### Trade Simulator äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“

> ç‹¬ç«‹çš„å•ä¾‹æœåŠ¡ï¼Œé€šè¿‡ `get_engine()` è¢« Tools å’Œ Middleware è®¿é—®

**å•ä¾‹æ¨¡å¼å®ç°ï¼š**

```python
# agent/trade_simulator/__init__.py
_engine: Optional[TradeSimulatorEngine] = None

def set_engine(engine: TradeSimulatorEngine) -> None:
    """åœ¨ agent_main.py å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡"""
    global _engine
    _engine = engine

def get_engine() -> Optional[TradeSimulatorEngine]:
    """å·¥å…·å’Œä¸­é—´ä»¶é€šè¿‡æ­¤æ–¹æ³•è®¿é—®å¼•æ“"""
    return _engine
```

**æ¶æ„è®¾è®¡ï¼š**

```mermaid
graph TB
    subgraph "å¤–éƒ¨è®¿é—®"
        Tools["Agent Tools<br/>é€šè¿‡ get_engine è®¿é—®"]
        Middleware["Middleware<br/>é€šè¿‡ get_engine è®¿é—®"]
    end

    subgraph "TradeSimulatorEngine å•ä¾‹"
        API["å¯¹å¤– API<br/>open_position/close_position/etc"]
        
        subgraph "æ ¸å¿ƒæœåŠ¡"
            PM["PositionManager<br/>æŒä»“ç®¡ç†"]
            TPSL["TPSLManager<br/>æ­¢ç›ˆæ­¢æŸ"]
            Risk["RiskService<br/>é£æ§æœåŠ¡"]
            StateMgr["StateManager<br/>çŠ¶æ€ç®¡ç†"]
        end
        
        subgraph "å¸‚åœºè®¢é˜…"
            MarketSub["MarketSubscription<br/>WebSocket 1m Kçº¿"]
        end
    end

    subgraph "æ•°æ®æ¨¡å‹"
        Account["Account<br/>è´¦æˆ·æ¨¡å‹"]
        Position["Position<br/>æŒä»“æ¨¡å‹"]
    end

    subgraph "å¤–éƒ¨æœåŠ¡"
        REST["Binance REST API<br/>è·å–å½“å‰ä»·æ ¼"]
        WS["Binance WebSocket<br/>å®æ—¶Kçº¿æµ"]
    end

    subgraph "æŒä¹…åŒ–"
        TradeState["trade_state.json<br/>å¼•æ“çŠ¶æ€"]
        PosHistory["position_history.json<br/>å¹³ä»“å†å²"]
    end

    Tools -.get_engine.-> API
    Middleware -.get_engine.-> API
    
    API --> PM
    API --> TPSL
    API --> Risk
    API --> StateMgr
    
    PM --> Account
    PM --> Position
    PM --> REST
    
    TPSL --> MarketSub
    TPSL --> PM
    
    Risk --> Account
    
    StateMgr --> TradeState
    StateMgr --> PosHistory
    
    MarketSub --> WS
    WS -.å®æ—¶Kçº¿.-> TPSL
    
    style API fill:#ffccbc,stroke:#e64a19,stroke-width:3px
    style PM fill:#fff3e0
    style TPSL fill:#fce4ec
```

**å…³é”®ç‰¹ç‚¹ï¼š**
- âœ… **å…¨å±€å•ä¾‹**ï¼šæ•´ä¸ª Agent è¿›ç¨‹å…±äº«ä¸€ä¸ªå¼•æ“å®ä¾‹
- ğŸ”— **è§£è€¦è®¿é—®**ï¼šå·¥å…·é€šè¿‡ `get_engine()` è®¿é—®ï¼Œæ— ç›´æ¥ä¾èµ–
- ğŸ“Š **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ”¯æŒä¸­æ–­æ¢å¤ï¼ˆtrade_state.jsonï¼‰
- âš¡ **å®æ—¶ç›‘æ§**ï¼šWebSocket è®¢é˜…æŒä»“å¸ç§çš„å®æ—¶ä»·æ ¼

**æ ¸å¿ƒæœåŠ¡è¯¦è§£ï¼š**

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **TradeSimulatorEngine** | `simulator.py` | â€¢ åè°ƒæ‰€æœ‰æœåŠ¡<br/>â€¢ æä¾›ç»Ÿä¸€API<br/>â€¢ ç®¡ç†ç”Ÿå‘½å‘¨æœŸ |
| **PositionManager** | `position_manager.py` | â€¢ å¼€ä»“/åŠ ä»“é€»è¾‘<br/>â€¢ å¹³ä»“é€»è¾‘<br/>â€¢ ä¿è¯é‡‘è®¡ç®—<br/>â€¢ æŒä»“æ±‡æ€» |
| **TPSLManager** | `tpsl_manager.py` | â€¢ ç›‘å¬å®æ—¶Kçº¿<br/>â€¢ æ£€æµ‹æ­¢ç›ˆæ­¢æŸè§¦å‘<br/>â€¢ è‡ªåŠ¨å¹³ä»“æ‰§è¡Œ<br/>â€¢ æ›´æ–°TP/SLä»·æ ¼ |
| **RiskService** | `risk_service.py` | â€¢ æ‰‹ç»­è´¹è®¡ç®—<br/>â€¢ è´¦æˆ·æƒç›Šæ ‡è®°<br/>â€¢ ä¿è¯é‡‘æ£€æŸ¥<br/>â€¢ ç™¾åˆ†æ¯”å½’ä¸€åŒ– |
| **StateManager** | `state_manager.py` | â€¢ çŠ¶æ€æ¢å¤<br/>â€¢ çŠ¶æ€æŒä¹…åŒ–<br/>â€¢ æ“ä½œæ—¥å¿—è®°å½•<br/>â€¢ å¹³ä»“å†å²å½’æ¡£ |
| **MarketSubscription** | `market_subscription.py` | â€¢ WebSocketè®¢é˜…ç®¡ç†<br/>â€¢ å®æ—¶Kçº¿æ¨é€<br/>â€¢ é‡è¿æœºåˆ¶ |

**æ•°æ®æ¨¡å‹ï¼š**

```python
# Accountï¼ˆè´¦æˆ·æ¨¡å‹ï¼‰
{
    "balance": 10000.0,        # ä½™é¢
    "equity": 10100.0,         # æƒç›Š
    "realized_pnl": 100.0,     # å·²å®ç°ç›ˆäº
    "unrealized_pnl": 50.0,    # æœªå®ç°ç›ˆäº
    "reserved_margin_sum": 500.0,  # å·²ç”¨ä¿è¯é‡‘
    "positions_count": 2,      # æŒä»“æ•°é‡
    "margin_usage_rate": 5.0   # ä¿è¯é‡‘åˆ©ç”¨ç‡ï¼ˆ%ï¼‰
}

# Positionï¼ˆæŒä»“æ¨¡å‹ï¼‰
{
    "id": "abc123",            # æŒä»“ID
    "symbol": "BTCUSDT",       # äº¤æ˜“å¯¹
    "side": "long",            # æ–¹å‘ï¼ˆlong/shortï¼‰
    "qty": 0.1,                # æ•°é‡
    "entry_price": 50000.0,    # å…¥åœºä»·
    "tp_price": 51000.0,       # æ­¢ç›ˆä»·
    "sl_price": 49500.0,       # æ­¢æŸä»·
    "leverage": 5,             # æ æ†å€æ•°
    "notional_usdt": 5000.0,   # åä¹‰ä»·å€¼
    "margin_used": 1000.0,     # å ç”¨ä¿è¯é‡‘
    "status": "open",          # çŠ¶æ€ï¼ˆopen/closedï¼‰
    "unrealized_pnl": 100.0,   # æœªå®ç°ç›ˆäº
    "roe": 0.10                # æ”¶ç›Šç‡
}
```

---

## 3. æ•°æ®æµå›¾

### 3.1 ä¸¤ä¸ªç‹¬ç«‹æ¨¡å—çš„å®Œæ•´æ•°æ®æµ

```mermaid
sequenceDiagram
    participant Binance as Binance API
    participant Monitor as å‘Šè­¦ç›‘æ§æ¨¡å—<br/>(æŒç»­è¿è¡Œ)
    participant AlertsFile as alerts.jsonl
    participant Timer as Agent å®šæ—¶å™¨<br/>(ç‹¬ç«‹è¿›ç¨‹)
    participant Agent as AI Agent
    participant Simulator as äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“
    participant ReportsFile as reports.json

    Note over Binance,Monitor: æµç¨‹1ï¼šå‘Šè­¦ç›‘æ§ï¼ˆæŒç»­è¿è¡Œï¼‰
    loop å®æ—¶ç›‘æ§
        Binance->>Monitor: WebSocketæ¨é€Kçº¿
        Monitor->>Monitor: è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        Monitor->>Monitor: æ‰§è¡Œå¼‚å¸¸æ£€æµ‹
        
        alt æ£€æµ‹åˆ°å¼‚å¸¸
            Monitor->>Monitor: èšåˆå‘Šè­¦ï¼ˆå¤šå¸ç§ï¼‰
            Monitor->>AlertsFile: è¿½åŠ å†™å…¥å‘Šè­¦è®°å½•
            Monitor->>Monitor: å‘é€é‚®ä»¶é€šçŸ¥
        end
    end

    Note over Timer,Agent: æµç¨‹2ï¼šAgent å®šæ—¶åˆ†æï¼ˆç‹¬ç«‹è§¦å‘ï¼‰
    Timer->>Agent: å®šæ—¶å”¤é†’<br/>(ä¸‹æ¬¡å”¤é†’æ—¶é—´ç”±ä¸Šæ¬¡æ‰§è¡Œè®¾å®š)
    Agent->>AlertsFile: è¯»å–æœ€æ–°èšåˆå‘Šè­¦
    Agent->>Agent: æ³¨å…¥Kçº¿ä¸Šä¸‹æ–‡ï¼ˆå‰5å¸ç§ï¼‰
    
    loop Agentå†³ç­–å¾ªç¯
        Agent->>Agent: åˆ†æå¸‚åœºä¸æŒä»“
        Agent->>Binance: è·å–å¤šå‘¨æœŸKçº¿/æŒ‡æ ‡
        Binance-->>Agent: è¿”å›æ•°æ®
        
        alt å‘ç°äº¤æ˜“æœºä¼š
            Agent->>Simulator: å¼€ä»“/å¹³ä»“/è°ƒæ•´
            Simulator->>Simulator: æ›´æ–°æŒä»“å’Œè´¦æˆ·
            Simulator-->>Agent: è¿”å›æ‰§è¡Œç»“æœ
        end
    end
    
    Agent->>Agent: ç”Ÿæˆåˆ†ææŠ¥å‘Š
    Agent->>ReportsFile: å†™å…¥æŠ¥å‘Š
    Agent->>Agent: è®¡ç®—å¹¶è®¾ç½®ä¸‹æ¬¡å”¤é†’æ—¶é—´<br/>(æŒä»“æœŸé—´3-5åˆ†é’Ÿï¼Œæ— æŒä»“10-15åˆ†é’Ÿ)
    
    Note over Simulator,Binance: æµç¨‹3ï¼šæ­¢ç›ˆæ­¢æŸç›‘æ§ï¼ˆç‹¬ç«‹WebSocketï¼‰
    loop æŒä»“æœŸé—´
        Binance->>Simulator: WebSocketæ¨é€å®æ—¶Kçº¿
        Simulator->>Simulator: æ£€æŸ¥TP/SLè§¦å‘
        
        alt TPæˆ–SLè§¦å‘
            Simulator->>Simulator: è‡ªåŠ¨å¹³ä»“
            Simulator->>Simulator: æ›´æ–°è´¦æˆ·
            Simulator->>ReportsFile: è®°å½•å¹³ä»“å†å²
        end
    end

    Note over Monitor,Agent: å…³é”®ï¼šä¸¤ä¸ªæ¨¡å—å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œ<br/>ä»…é€šè¿‡ alerts.jsonl æ–‡ä»¶é€šä¿¡
```

### 3.2 é…ç½®ä¸çŠ¶æ€æ–‡ä»¶å…³ç³»

```mermaid
graph LR
    subgraph "é…ç½®æ–‡ä»¶"
        ConfigYAML["config.yaml<br/>ç³»ç»Ÿé…ç½®"]
        EnvFile[".env<br/>æ•æ„Ÿä¿¡æ¯"]
    end

    subgraph "è¿è¡Œæ—¶æ•°æ®"
        Alerts["alerts.jsonl<br/>å‘Šè­¦è®°å½•"]
        Reports["agent_reports.json<br/>AgentæŠ¥å‘Š"]
        PosHistory["position_history.json<br/>å¹³ä»“å†å²"]
    end

    subgraph "çŠ¶æ€æ–‡ä»¶"
        AgentState["agent/state.json<br/>AgentçŠ¶æ€"]
        TradeState["agent/trade_state.json<br/>äº¤æ˜“å¼•æ“çŠ¶æ€"]
    end

    ConfigYAML -.é…ç½®.-> Monitor["å‘Šè­¦ç›‘æ§æ¨¡å—"]
    ConfigYAML -.é…ç½®.-> Agent["AI Agent"]
    EnvFile -.æ•æ„Ÿä¿¡æ¯.-> Agent
    
    Monitor --> Alerts
    Agent --> Reports
    Agent --> AgentState
    
    Simulator["äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“"] --> TradeState
    Simulator --> PosHistory
    
    Alerts -.è¯»å–.-> Agent
    TradeState -.æ¢å¤.-> Simulator
    
    style ConfigYAML fill:#e1f5fe
    style EnvFile fill:#fff3e0
    style Alerts fill:#f3e5f5
    style Reports fill:#e8f5e9
```

---

## 4. å…³é”®ç‰¹æ€§

### 4.1 æ¶æ„è®¾è®¡ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **å®Œå…¨è§£è€¦** | ç›‘æ§æ¨¡å—å’Œ Agent æ¨¡å—é€šè¿‡æ–‡ä»¶ç³»ç»Ÿé€šä¿¡ | â€¢ äº’ä¸å½±å“ï¼Œç‹¬ç«‹éƒ¨ç½²<br/>â€¢ Agent å´©æºƒä¸å½±å“ç›‘æ§<br/>â€¢ å¯ä»¥å•ç‹¬æµ‹è¯•å’Œå‡çº§ |
| **ç‹¬ç«‹è¿›ç¨‹** | ä¸¤ä¸ªæ¨¡å—è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ | â€¢ èµ„æºéš”ç¦»<br/>â€¢ ä¾¿äºæ¨ªå‘æ‰©å±•<br/>â€¢ æ•…éšœéš”ç¦» |
| **è‡ªæˆ‘å®šæ—¶** | Agent è‡ªå·±å†³å®šä¸‹æ¬¡å”¤é†’æ—¶é—´ | â€¢ æ ¹æ®æŒä»“æƒ…å†µåŠ¨æ€è°ƒæ•´<br/>â€¢ æ— éœ€å¤–éƒ¨å¤æ‚è°ƒåº¦é€»è¾‘<br/>â€¢ æ›´çµæ´»çš„æ‰§è¡Œé¢‘ç‡ |
| **æ–‡ä»¶é€šä¿¡** | ä½¿ç”¨ JSONL æ ¼å¼çš„æµæ°´æ–‡ä»¶ | â€¢ ç®€å•å¯é <br/>â€¢ æ˜“äºè°ƒè¯•å’Œå®¡è®¡<br/>â€¢ æ”¯æŒå¤šè¯»è€…æ¨¡å¼ |

### 4.2 å‘Šè­¦ç›‘æ§æ¨¡å—ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å®æ—¶ç›‘æ§** | WebSocket è¿æ¥ï¼Œæ¯«ç§’çº§ K çº¿æ›´æ–° |
| **å¤šç»´åº¦æ£€æµ‹** | 15+ ç§æŠ€æœ¯æŒ‡æ ‡å’Œå½¢æ€è¯†åˆ«ç­–ç•¥ |
| **æ™ºèƒ½è¿‡æ»¤** | Z-Score æ ‡å‡†åŒ–ï¼Œå‡å°‘è¯¯æŠ¥ |
| **æ‰¹é‡èšåˆ** | æŒ‰æ—¶é—´çª—å£èšåˆå¤šå¸ç§å‘Šè­¦ |
| **è‡ªåŠ¨é€šçŸ¥** | SMTP é‚®ä»¶å®æ—¶å‘Šè­¦ |
| **åŠ¨æ€äº¤æ˜“å¯¹** | è‡ªåŠ¨æ›´æ–°æ´»è·ƒäº¤æ˜“å¯¹åˆ—è¡¨ |
| **æŒç»­è¿è¡Œ** | 7Ã—24 å°æ—¶ä¸é—´æ–­ç›‘æ§ |

### 4.3 AI Agent ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æ—è·¯è®¾è®¡** | ç‹¬ç«‹äºç›‘æ§ç³»ç»Ÿï¼Œè¯»å–å‘Šè­¦æ–‡ä»¶ |
| **è‡ªæˆ‘è°ƒåº¦** | æ ¹æ®æŒä»“æƒ…å†µåŠ¨æ€è®¾ç½®æ‰§è¡Œé—´éš” |
| **å¤šå‘¨æœŸåˆ†æ** | æ”¯æŒ 3m/15m/1h/4h å¤šæ—¶é—´æ¡†æ¶ |
| **ä¸Šä¸‹æ–‡é¢„æ³¨å…¥** | å‡å°‘å·¥å…·è°ƒç”¨ï¼ŒåŠ å¿«å†³ç­– |
| **åŠ¨æ€ä»“ä½ç®¡ç†** | æ ¹æ®ä¿¡å·å¼ºåº¦å’Œé£é™©åŠ¨æ€è®¡ç®—ä»“ä½ |
| **ä¿è¯é‡‘åˆ©ç”¨ç‡ç›‘æ§** | å®æ—¶ç›‘æ§èµ„é‡‘ä½¿ç”¨æ•ˆç‡ |
| **å®Œæ•´æŠ¥å‘Š** | æ¯æ¬¡åˆ†æç”Ÿæˆè¯¦ç»†æŠ¥å‘Š |
| **çŠ¶æ€æŒä¹…åŒ–** | æ”¯æŒä¸­æ–­æ¢å¤ |

### 4.4 äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å…¨ä»“ä¿è¯é‡‘** | æ¨¡æ‹ŸçœŸå®äº¤æ˜“ç¯å¢ƒ |
| **å®æ—¶æ­¢ç›ˆæ­¢æŸ** | WebSocket ç›‘å¬ï¼Œè‡ªåŠ¨è§¦å‘ |
| **æ‰‹ç»­è´¹æ¨¡æ‹Ÿ** | Taker 0.05% æ‰‹ç»­è´¹ |
| **æŒä»“ç®¡ç†** | æ”¯æŒåŠ ä»“ã€å‡ä»“ã€æ›´æ–°TP/SL |
| **é£æ§æœåŠ¡** | ä¿è¯é‡‘æ£€æŸ¥ã€æƒç›Šæ ‡è®° |
| **å†å²å½’æ¡£** | å®Œæ•´è®°å½•æ¯ç¬”äº¤æ˜“ |

---

## 5. æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **Python 3.11+** | ä¸»è¦ç¼–ç¨‹è¯­è¨€ |
| **LangChain** | AI Agent æ¡†æ¶ |
| **OpenAI API** | å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¯é…ç½®å…¶ä»–æ¨¡å‹ï¼‰ |
| **NumPy/Pandas** | æ•°æ®å¤„ç†å’Œè®¡ç®— |
| **WebSocket** | å®æ—¶æ•°æ®æµ |
| **SMTP** | é‚®ä»¶é€šçŸ¥ |

### æ•°æ®å­˜å‚¨

| ç±»å‹ | æ ¼å¼ | ç”¨é€” |
|------|------|------|
| **é…ç½®** | YAML + .env | ç³»ç»Ÿé…ç½®å’Œæ•æ„Ÿä¿¡æ¯ |
| **å‘Šè­¦** | JSONL | å‘Šè­¦æµæ°´è®°å½• |
| **æŠ¥å‘Š** | JSON | Agent åˆ†ææŠ¥å‘Š |
| **çŠ¶æ€** | JSON | ç³»ç»ŸçŠ¶æ€æŒä¹…åŒ– |
| **å†å²** | JSON | äº¤æ˜“å†å²å½’æ¡£ |

### å¤–éƒ¨ä¾èµ–

| æœåŠ¡ | ç”¨é€” |
|------|------|
| **Binance API** | è¡Œæƒ…æ•°æ®å’Œäº¤æ˜“æ¥å£ |
| **SMTP æœåŠ¡å™¨** | é‚®ä»¶å‘é€ |
| **OpenAI API** | LLM æœåŠ¡ï¼ˆæˆ–å…¶ä»–å…¼å®¹æœåŠ¡ï¼‰ |

---

## 6. éƒ¨ç½²æ¶æ„

### 6.1 è¿›ç¨‹æ¨¡å‹

```mermaid
graph TB
    subgraph "è¿›ç¨‹1 - å‘Šè­¦ç›‘æ§ç‹¬ç«‹æŒç»­è¿è¡Œ"
        MonitorProcess["ç›‘æ§ä¸»è¿›ç¨‹<br/>WebSocketè¿æ¥æ± "]
    end

    subgraph "è¿›ç¨‹2 - Agentæ—è·¯ç‹¬ç«‹å®šæ—¶è¿è¡Œ"
        AgentProcess["Agent ä¸»è¿›ç¨‹<br/>è‡ªæˆ‘å®šæ—¶è°ƒåº¦"]
        SimEngine["äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“<br/>WebSocketè®¢é˜…æŒä»“"]
    end

    subgraph "æ–‡ä»¶ç³»ç»Ÿè§£è€¦é€šä¿¡"
        AlertsFile["alerts.jsonl<br/>å‘Šè­¦æµæ°´"]
        ReportsFile["agent_reports.json<br/>åˆ†ææŠ¥å‘Š"]
        StateFiles["state.json<br/>trade_state.json<br/>çŠ¶æ€æŒä¹…åŒ–"]
    end

    subgraph "å¤–éƒ¨æœåŠ¡"
        BinanceAPI["Binance API"]
    end

    MonitorProcess -.å†™å…¥.-> AlertsFile
    MonitorProcess -.WebSocket.-> BinanceAPI
    
    AgentProcess -.å®šæ—¶è¯»å–.-> AlertsFile
    AgentProcess --> SimEngine
    AgentProcess -.å†™å…¥.-> ReportsFile
    
    SimEngine -.WebSocket.-> BinanceAPI
    SimEngine -.å†™å…¥.-> StateFiles
    
    style MonitorProcess fill:#e3f2fd
    style AgentProcess fill:#fff9c4
    style SimEngine fill:#ffccbc
    style AlertsFile fill:#f0f0f0,stroke:#333,stroke-width:3px
```

**å…³é”®ç‰¹ç‚¹ï¼š**
- âœ… **å®Œå…¨è§£è€¦**ï¼šä¸¤ä¸ªè¿›ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸ä¾èµ–
- ğŸ“ **æ–‡ä»¶é€šä¿¡**ï¼šé€šè¿‡ `alerts.jsonl` å•å‘ä¼ é€’ä¿¡æ¯
- ğŸ”„ **å„è‡ªå¾ªç¯**ï¼šç›‘æ§æŒç»­ç›‘å¬ï¼ŒAgent è‡ªæˆ‘å®šæ—¶

### 6.2 è¿è¡Œæ¨¡å¼

#### è¿›ç¨‹1ï¼šå‘Šè­¦ç›‘æ§æ¨¡å—
```bash
# å¯åŠ¨æ–¹å¼
python main.py  # æˆ–ä½¿ç”¨ systemd å®ˆæŠ¤è¿›ç¨‹

# è¿è¡Œç‰¹ç‚¹
- æŒç»­è¿è¡Œï¼Œä¸é€€å‡º
- ç›‘å¬å¤šä¸ªäº¤æ˜“å¯¹çš„å®æ—¶ K çº¿
- æ£€æµ‹åˆ°å¼‚å¸¸ â†’ å†™å…¥ alerts.jsonl
- ç‹¬ç«‹çš„é‚®ä»¶é€šçŸ¥æµç¨‹
```

#### è¿›ç¨‹2ï¼šAI Agent æ—è·¯
```bash
# å¯åŠ¨æ–¹å¼ï¼ˆé€šå¸¸ç”¨ cron æˆ– systemd timerï¼‰
python agent/agent_main.py

# è¿è¡Œç‰¹ç‚¹
- å•æ¬¡æ‰§è¡Œå®Œæˆåè‡ªåŠ¨é€€å‡º
- è¯»å– alerts.jsonl è·å–å¸‚åœºä¿¡æ¯
- å®Œæˆåˆ†æåå†™å…¥ agent_reports.json
- åœ¨ state.json ä¸­è®°å½•ä¸‹æ¬¡å”¤é†’æ—¶é—´
- ç”±å¤–éƒ¨è°ƒåº¦å™¨æ ¹æ®ä¸‹æ¬¡å”¤é†’æ—¶é—´é‡æ–°å¯åŠ¨
```

**å®šæ—¶è°ƒåº¦ç¤ºä¾‹ï¼ˆcrontabï¼‰ï¼š**
```bash
# æ£€æŸ¥ state.json ä¸­çš„ next_wakeup_tsï¼Œåˆ°æ—¶é—´åˆ™æ‰§è¡Œ
*/1 * * * * /path/to/check_and_run_agent.sh
```

#### äº¤æ˜“æ¨¡æ‹Ÿå¼•æ“
```
- éš Agent è¿›ç¨‹å¯åŠ¨å’Œé€€å‡º
- Agent æ‰§è¡ŒæœŸé—´æŒç»­ç›‘å¬æŒä»“çš„å®æ—¶ä»·æ ¼
- è‡ªåŠ¨æ‰§è¡Œæ­¢ç›ˆæ­¢æŸï¼ˆå†™å…¥å†å²è®°å½•ï¼‰
- Agent é€€å‡ºå‰æŒä¹…åŒ–çŠ¶æ€åˆ° trade_state.json
```

---

## 7. é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶ç»“æ„

```
config/
â”œâ”€â”€ config.yaml          # ä¸»é…ç½®æ–‡ä»¶ï¼ˆéæ•æ„Ÿï¼‰
â”œâ”€â”€ settings.py          # é…ç½®åŠ è½½å™¨
â””â”€â”€ README.md           # é…ç½®è¯´æ˜æ–‡æ¡£

.env                     # ç¯å¢ƒå˜é‡ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Œä¸æäº¤gitï¼‰
```

### é…ç½®æ¥æºåŸåˆ™

| é…ç½®ç±»å‹ | æ¥æº | ç¤ºä¾‹ |
|---------|------|------|
| **æ•æ„Ÿä¿¡æ¯** | `.env` | APIå¯†é’¥ã€å¯†ç ã€é‚®ç®± |
| **å…¶ä»–é…ç½®** | `config.yaml` | æŠ€æœ¯æŒ‡æ ‡å‚æ•°ã€é˜ˆå€¼ã€è·¯å¾„ |

**ä¸æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›– config.yamlï¼Œä¿æŒé…ç½®æ¥æºå•ä¸€ã€‚**

---

## 8. ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç³»ç»Ÿ

```
logs/
â”œâ”€â”€ agent_YYYYMMDD_HHMMSS.log    # Agent è¿è¡Œæ—¥å¿—
â”œâ”€â”€ monitor_YYYYMMDD_HHMMSS.log  # ç›‘æ§æ¨¡å—æ—¥å¿—
â”œâ”€â”€ agent_reports.json           # Agent åˆ†ææŠ¥å‘Š
â””â”€â”€ position_history.json        # äº¤æ˜“å†å²è®°å½•
```

### å…³é”®æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| **ä¿è¯é‡‘åˆ©ç”¨ç‡** | `get_account_summary()` | å®æ—¶è®¡ç®—ï¼Œå‘Šè­¦æç¤º |
| **æŒä»“æ•°é‡** | `get_positions_summary()` | é£é™©åˆ†æ•£ç›‘æ§ |
| **å·²å®ç°ç›ˆäº** | `position_history.json` | ç­–ç•¥ç»©æ•ˆè¯„ä¼° |
| **å‘Šè­¦è§¦å‘é¢‘ç‡** | `alerts.jsonl` | å¸‚åœºæ´»è·ƒåº¦æŒ‡æ ‡ |
| **Agent æ‰§è¡Œé¢‘ç‡** | `agent_reports.json` | ç³»ç»Ÿå¥åº·åº¦ç›‘æ§ |

---

## 9. æ‰©å±•æ€§è®¾è®¡

### æ˜“äºæ‰©å±•çš„éƒ¨åˆ†

1. **æ–°å¢æ£€æµ‹ç­–ç•¥**ï¼šåœ¨ `detection/strategies.py` æ·»åŠ æ–°æ–¹æ³•
2. **æ–°å¢æŠ€æœ¯æŒ‡æ ‡**ï¼šåœ¨ `indicators/` æ·»åŠ æ–°æ¨¡å—
3. **æ–°å¢ Agent å·¥å…·**ï¼šåœ¨ `agent/tools/` æ·»åŠ æ–°å·¥å…·
4. **æ›´æ¢ LLM**ï¼šä¿®æ”¹ `.env` ä¸­çš„æ¨¡å‹é…ç½®
5. **è‡ªå®šä¹‰ä¸­é—´ä»¶**ï¼šç»§æ‰¿ `AgentMiddleware` ç±»

### æ¨¡å—åŒ–è®¾è®¡

**ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ç³»ç»Ÿï¼š**

| æ¨¡å— | è¿è¡Œæ–¹å¼ | é€šä¿¡æ–¹å¼ | éƒ¨ç½²æ–¹å¼ |
|------|---------|---------|---------|
| **å‘Šè­¦ç›‘æ§** | æŒç»­è¿è¡Œï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰ | å†™å…¥ `alerts.jsonl` | ç‹¬ç«‹éƒ¨ç½²ï¼Œå¯å•ç‹¬å‡çº§ |
| **AI Agent** | å®šæ—¶æ‰§è¡Œï¼ˆå•æ¬¡è¿è¡Œï¼‰ | è¯»å– `alerts.jsonl` | ç‹¬ç«‹éƒ¨ç½²ï¼Œå¯å•ç‹¬æµ‹è¯• |

**è§£è€¦ä¼˜åŠ¿ï¼š**
- âœ… Agent å¯ä»¥åœæ­¢è€Œä¸å½±å“å‘Šè­¦ç›‘æ§
- âœ… å‘Šè­¦ç›‘æ§å¯ä»¥é‡å¯è€Œä¸å½±å“ Agent çŠ¶æ€
- âœ… å¯ä»¥åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šè¿è¡Œä¸¤ä¸ªæ¨¡å—
- âœ… å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²
- âœ… **äº¤æ˜“å¼•æ“**å¯åˆ‡æ¢ä¸ºå®ç›˜ï¼ˆéœ€ä¿®æ”¹ REST å®¢æˆ·ç«¯ï¼‰

---

## 10. å®‰å…¨æ€§è€ƒè™‘

| æªæ–½ | è¯´æ˜ |
|------|------|
| **æ•æ„Ÿä¿¡æ¯éš”ç¦»** | APIå¯†é’¥å­˜å‚¨åœ¨ `.env`ï¼Œä¸æäº¤ç‰ˆæœ¬æ§åˆ¶ |
| **æ¨¡æ‹Ÿäº¤æ˜“** | é»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿå¼•æ“ï¼Œé¿å…çœŸå®èµ„é‡‘é£é™© |
| **æ‰‹ç»­è´¹æ¨¡æ‹Ÿ** | çœŸå®æ¨¡æ‹Ÿäº¤æ˜“æˆæœ¬ |
| **ä¿è¯é‡‘æ£€æŸ¥** | ä¸¥æ ¼çš„é£æ§æ£€æŸ¥ï¼Œé˜²æ­¢è¿‡åº¦æ æ† |
| **çŠ¶æ€æŒä¹…åŒ–** | é¿å…æ„å¤–é‡å¯å¯¼è‡´çŠ¶æ€ä¸¢å¤± |

---

## é™„å½•ï¼šå…³é”®æ–‡ä»¶æ¸…å•

### å‘Šè­¦ç›‘æ§æ¨¡å— (src/)

```
src/
â”œâ”€â”€ alerts/
â”‚   â”œâ”€â”€ manager.py          # å‘Šè­¦ç®¡ç†å™¨
â”‚   â”œâ”€â”€ notifier.py         # é‚®ä»¶é€šçŸ¥
â”‚   â””â”€â”€ callbacks.py        # Kçº¿å›è°ƒ
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ binance_ws.py       # WebSocketå®¢æˆ·ç«¯
â”‚   â””â”€â”€ binance_rest.py     # RESTå®¢æˆ·ç«¯
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ exchange_manager.py # äº¤æ˜“å¯¹ç®¡ç†
â”‚   â”œâ”€â”€ initializer.py      # ç³»ç»Ÿåˆå§‹åŒ–
â”‚   â””â”€â”€ symbol_updater.py   # äº¤æ˜“å¯¹æ›´æ–°
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ kline_manager.py    # Kçº¿æ•°æ®ç®¡ç†
â”‚   â””â”€â”€ models.py           # æ•°æ®æ¨¡å‹
â”œâ”€â”€ detection/
â”‚   â”œâ”€â”€ detector.py         # å¼‚å¸¸æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ strategies.py       # æ£€æµ‹ç­–ç•¥
â”‚   â””â”€â”€ zscore.py           # Z-Scoreè®¡ç®—
â”œâ”€â”€ indicators/
â”‚   â”œâ”€â”€ calculator.py       # æŒ‡æ ‡åè°ƒå™¨
â”‚   â”œâ”€â”€ atr.py              # ATRæŒ‡æ ‡
â”‚   â”œâ”€â”€ volatility.py       # æ³¢åŠ¨ç‡æŒ‡æ ‡
â”‚   â”œâ”€â”€ volume.py           # æˆäº¤é‡æŒ‡æ ‡
â”‚   â””â”€â”€ pattern.py          # Kçº¿å½¢æ€
â””â”€â”€ utils/
    â”œâ”€â”€ logger.py           # æ—¥å¿—å·¥å…·
    â”œâ”€â”€ helpers.py          # è¾…åŠ©å‡½æ•°
    â””â”€â”€ validators.py       # éªŒè¯å·¥å…·
```

### AI Agent æ¨¡å— (agent/)

```
agent/
â”œâ”€â”€ agent_main.py           # ä¸»å…¥å£
â”œâ”€â”€ state.py                # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ log_reader.py           # æ—¥å¿—è¯»å–
â”œâ”€â”€ trade_prompt.md         # Agentç³»ç»Ÿæç¤ºè¯
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ context_injection_middleware.py  # ä¸Šä¸‹æ–‡æ³¨å…¥
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ get_kline_tool.py   # Kçº¿å·¥å…·
â”‚   â”œâ”€â”€ get_indicators_tool.py  # æŒ‡æ ‡å·¥å…·
â”‚   â”œâ”€â”€ get_account_tool.py # è´¦æˆ·å·¥å…·
â”‚   â”œâ”€â”€ get_positions_tool.py   # æŒä»“å·¥å…·
â”‚   â”œâ”€â”€ open_position_tool.py   # å¼€ä»“å·¥å…·
â”‚   â”œâ”€â”€ close_position_tool.py  # å¹³ä»“å·¥å…·
â”‚   â”œâ”€â”€ update_tp_sl_tool.py    # æ›´æ–°TP/SL
â”‚   â”œâ”€â”€ write_report_tool.py    # æŠ¥å‘Šå·¥å…·
â”‚   â””â”€â”€ send_email_tool.py      # é‚®ä»¶å·¥å…·
â””â”€â”€ trade_simulator/
    â”œâ”€â”€ __init__.py         # å•ä¾‹å…¥å£
    â”œâ”€â”€ models.py           # æ•°æ®æ¨¡å‹
    â”œâ”€â”€ storage.py          # å­˜å‚¨å·¥å…·
    â””â”€â”€ engine/
        â”œâ”€â”€ simulator.py    # ä¸»åè°ƒå™¨
        â”œâ”€â”€ position_manager.py  # æŒä»“ç®¡ç†
        â”œâ”€â”€ tpsl_manager.py      # TP/SLç®¡ç†
        â”œâ”€â”€ risk_service.py      # é£æ§æœåŠ¡
        â”œâ”€â”€ state_manager.py     # çŠ¶æ€ç®¡ç†
        â””â”€â”€ market_subscription.py  # å¸‚åœºè®¢é˜…
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-26  
**ç»´æŠ¤è€…**: System Architecture Team

