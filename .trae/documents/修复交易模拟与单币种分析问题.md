## 目标范围
- 聚焦交易模拟模块与单币种分析节点及其工具链的逻辑缺陷与安全/一致性问题。

## 发现问题与改进点
### 交易模拟模块（trade_simulator）
1. **限价单成交价格未生效**
   - `_fill_order` 计算了 `filled_price`，但仍调用 `open_position` 的“市价”路径（内部会用 REST 获取最新收盘价），导致成交价偏离预期。
   - 位置：[limit_order_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/limit_order_manager.py#L253-L279)
2. **限价单不预占保证金**
   - `create_limit_order` 检查保证金但不增加 `reserved_margin_sum`，同时可以挂多单导致超额占用。
   - 位置：[limit_order_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/limit_order_manager.py#L92-L118)
3. **杠杆上限硬编码不一致**
   - `LimitOrderManager` 使用 1..125，但 `PositionManager` 使用 config 中的 `max_leverage`，存在不一致。
   - 位置：[limit_order_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/limit_order_manager.py#L88-L90)、[position_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/position_manager.py#L99-L101)
4. **平仓手续费未累加到账户总手续费**
   - `close_position` 直接用 `cfg.taker_fee_rate` 计算，未更新 `account.total_fees`。
   - 位置：[position_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/position_manager.py#L262-L270)
5. **平仓历史记录丢失原始数量/保证金**
   - 平仓时先把 `qty/notional/margin` 置 0，随后 `pos_to_dict` 写入，历史中数量为 0。
   - 位置：[position_manager.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/engine/position_manager.py#L272-L301)
6. **历史写入可能丢数据（并发覆盖）**
   - `append_position_history` 先读文件再写全量，多个并发 close 可能互相覆盖。
   - 位置：[storage.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/storage.py#L47-L56)、[file_utils.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/trade_simulator/utils/file_utils.py#L118-L136)

### 单币种分析节点与工具
1. **无用导入与未使用变量**
   - `BaseModel/ProviderStrategy`、`session_id`、`cfg` 均未使用，易误导与混淆。
   - 位置：[single_symbol_analysis_node.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/nodes/single_symbol_analysis_node.py#L17-L53)
2. **open_position_tool 与模拟引擎杠杆/风控不一致**
   - 工具层固定 10x 杠杆，但模拟引擎允许从 config 获取 max_leverage；逻辑分裂。
   - 位置：[open_position_tool.py](file:///Users/bytedance/Desktop/crypto_agentx/backend/modules/agent/tools/open_position_tool.py#L203-L268)

## 实施计划
### 1) 交易模拟一致性修复
- 在 `LimitOrderManager` 中引入 config `max_leverage`，并与 `PositionManager` 统一。
- 为限价单预占保证金：挂单时增加 `reserved_margin_sum`，取消/成交时释放或转移。
- 为 `_fill_order` 提供“指定成交价”的开仓路径（支持传入 entry 价格）。
- 修正平仓手续费统计：通过 `RiskService.charge_close_fee` 统一处理，并写入 `total_fees`。
- 平仓前缓存 `qty/notional/margin`，确保历史记录保留真实值。
- 历史持久化改为追加式 JSONL 或加锁写入，避免覆盖丢数据。

### 2) 单币种分析节点精简
- 移除未使用的导入与变量，保证代码可读性。
- 工具层参数与模拟引擎一致化（杠杆策略与约束统一）

### 3) 验证与回归
- 增加针对“限价单成交价”、“保证金预占/释放”、“平仓历史记录”的最小回归测试。
- 在模拟环境跑一次开仓→止盈/止损→平仓流程，检查历史文件与账户统计。

如果你确认，我会按这个计划逐步修改并验证。